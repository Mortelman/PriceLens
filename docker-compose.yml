x-app-service: &app-service
  env_file:
    - .env
  working_dir: /app
  volumes:
    - .:/app

services:
  api:
    <<: *app-service
    container_name: api
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    command: python apps/api/main.py
    ports:
      - "${API_PORT:-8080}:8080"
    # depends_on:
    #   postgres:
    #     condition: service_healthy

  web:
    <<: *app-service
    container_name: web
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    ports:
      - "${WEB_PORT:-8501}:8501"
    depends_on:
      api:
        condition: service_started

  # scheduler:
  #   <<: *app-service
  #   container_name: scheduler
  #   build:
  #     context: ./apps/scheduler
  #     dockerfile: Dockerfile
  #   command: python apps/scheduler/main.py

  # worker-ml:
  #   <<: *app-service
  #   container_name: worker-ml
  #   build:
  #     context: ./apps/worker-ml
  #     dockerfile: Dockerfile
  #   depends_on:
  #     postgres:
  #       condition: service_healthy

  # worker-notifier:
  #   <<: *app-service
  #   container_name: worker-notifier
  #   build:
  #     context: ./apps/worker-notifier
  #     dockerfile: Dockerfile
  #   depends_on:
  #     postgres:
  #       condition: service_healthy

  # worker-scraper:
  #   <<: *app-service
  #   container_name: worker-scraper
  #   build:
  #     context: ./apps/worker-scraper
  #     dockerfile: Dockerfile
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     scheduler:
  #       condition: service_started

  c4-diagram:
    container_name: pricelens-diagram
    image: likec4/likec4:latest
    working_dir: /data
    ports:
      - "5173:5173"
      - "24678:24678"
    command: ["start", "likec4"]
    volumes:
      - ./:/data

  # postgres:
  #   image: timescale/timescaledb:latest-pg16
  #   env_file:
  #     - .env
  #   environment:
  #     POSTGRES_DB: ${DB_NAME:-pricelens}
  #     POSTGRES_USER: ${DB_USER:-postgres}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
  #   ports:
  #     - "${DB_PORT:-5432}:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-pricelens}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

# volumes:
#   postgres_data:
